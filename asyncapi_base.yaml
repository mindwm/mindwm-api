asyncapi: 3.0.0
info:
  title: Mindwm API
  version: 3.0.0
  description: |
    Desktop event processing
  license:
    name: Apache 2.0
    url: 'https://www.apache.org/licenses/LICENSE-2.0'
servers:
  asciinema: 
    host: "/tmp/mindwm-asciinema-${MINDWM_UUID}.socket"
    protocol: unixsocket
    description: Asciinema
    variables:
      USER_HOST:
        default: localhost
    externalDocs:
      url: https://github.com/mindwm/mindwm-manager/blob/dc926f637bb8d31f21ecbd28479ab9b0a1ece23c/src/mindwm/modules/tmux_session.py
  mindwm-client:
    host: "/tmp/mindwm-asciinema-${MINDWM_UUID}.socket"
    protocol: unixsocket
    description: |
      Mindwm Client      
    variables:
      USER_HOSTNAME: 
        default: localhost 
    externalDocs:
      url: "https://github.com/mindwm/mindwm-manager/blob/dc926f637bb8d31f21ecbd28479ab9b0a1ece23c/src/mindwm/modules/pipe_listener.py"
  nats:
    host: '${address}:${port}'
    protocol: nats
    description: |
      Nats Server
    variables:
      address:
        enum:
          - "10.20.30.211" 
          - "nats.nats"
        default: nats.nats
      port:
        enum:
          - "31101"
          - "4222"
        default: "4222"
           
channels:
  TmuxPane:
    address: /tmp/mindwm-asciinema-${MINDWM_UUID}.socket
    externalDocs:
      url: https://github.com/mindwm/mindwm-manager/blob/dc926f637bb8d31f21ecbd28479ab9b0a1ece23c/src/mindwm/modules/tmux_session.py#L33
    servers:
      - $ref: '#/servers/asciinema'
      - $ref: '#/servers/mindwm-client'
    messages:
      IoDocument: 
        $ref: '#/components/messages/IoDocument'

  HostJetStreamChannel:
    address: "KN_USER_${USERNAME}__${HOSTNAME}_BROKER_KNE_TRIGGER"
    servers: 
      - $ref: '#/servers/nats'
    externalDocs: 
      url: https://github.com/knative-extensions/eventing-natss
#  HostNatsTopicIn:
#    address: user-${USERNAME}.${HOSTNAME}-broker-kne-trigger._knative
#    servers: 
#      - $ref: '#/servers/nats'
#    messages:
#      GraphEvent:
#        $ref: '#/components/messages/GraphEvent'
  HostNatsTopicIoDocument:
    address: 'mindwm.${USER}.${HOSTNAME}.tmux.${TMUX_SOCKET}.${MINDWM_UUID}.${TMUX_ID}.${TMUX_PANE_ID}.iodocument'
    servers: 
      - $ref: '#/servers/nats'
    messages:
      IoDocumentEvent:
        $ref: '#/components/messages/IoDocumentEvent'
  HostNatsTopicClipboard:
    address: 'mindwm.${USER}.${HOSTNAME}.clipboard'
    servers: 
      - $ref: '#/servers/nats'
    messages:
      ClipboardEvent:
        $ref: '#/components/messages/ClipboardEvent'

  TouchChannel:
    address: 'mindwm.${USER}.${HOSTNAME}.touch'
    servers: 
      - $ref: '#/servers/nats'
    messages:
      TouchEvent:
        $ref: '#/components/messages/TouchEvent'
 
 
operations:
  IoDocument:
    action: send
    channel: 
      $ref: '#/channels/TmuxPane'
    messages:
      - $ref: '#/channels/TmuxPane/messages/IoDocument'

  IoDocumentEvent:
    action: send
    channel:
      $ref: '#/channels/HostNatsTopicIoDocument'
    messages:
      - $ref: '#/channels/HostNatsTopicIoDocument/messages/IoDocumentEvent'

#  GraphEvent:
#    action: send
#    channel:
#      $ref: '#/channels/HostNatsTopicIn'
#    messages:
#      - $ref: '#/channels/HostNatsTopicIn/messages/GraphEvent'

#  GraphEvent:
#    action: send
#    channel:
#      $ref: '#/channels/HostNatsTopicIn'
#    messages:
#      - $ref: '#/channels/HostNatsTopicIn/messages/GraphEvent'

  ClipboardEvent:
    action: send
    channel:
      $ref: '#/channels/HostNatsTopicClipboard'
    messages:
      - $ref: '#/channels/HostNatsTopicClipboard/messages/ClipboardEvent'

  TouchEvent:
    action: send
    channel:
      $ref: '#/channels/TouchChannel'
    messages:
      - $ref: '#/channels/TouchChannel/messages/TouchEvent'
    

components:
  messages:
    IoDocument:
      summary: "Basic IoDocument produced by mindwm-client"
      payload:
        $ref: '#/components/schemas/IoDocument'
    IoDocumentEvent:
      summary: "TmuxPaneIoDocument in cloudevent"
      payload:
        $ref: "#/components/schemas/IoDocumentEvent"
    Clipboard:
      summary: "Clipboard data"
      payload:
        $ref: '#/components/schemas/Clipboard'
    ClipboardEvent:
      summary: "Clipboard"
      payload:
        $ref: "#/components/schemas/ClipboardEvent"
    TouchEvent:
      summary: "update atime"
      payload:
        $ref: "#/components/schemas/TouchEvent"
